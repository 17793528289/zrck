<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šå‘˜ä¸­å¿ƒ - æ­¦å¨ç¬¬åå…«ä¸­å­¦å“ç„¶åˆ›å®¢ç¤¾å›¢</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <style>
        .member-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .member-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .user-info-card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .member-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .feature-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        /* æ·»åŠ Supabaseåˆå§‹åŒ–çŠ¶æ€æç¤º */
        .init-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .init-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .init-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
    </style>
    <!-- å¼•å…¥Supabaseå®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2><a href="index.html" style="color: white; text-decoration: none;">å“ç„¶åˆ›å®¢</a></h2>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">é¦–é¡µ</a></li>
                <li><a href="about.html">å…³äºæˆ‘ä»¬</a></li>
                <li><a href="activities.html">æ´»åŠ¨å±•ç¤º</a></li>
                <li><a href="projects.html">é¡¹ç›®æˆæœ</a></li>
                <li><a href="join.html">åŠ å…¥æˆ‘ä»¬</a></li>
                <li class="user-menu">
                    <span id="userWelcome">æ¬¢è¿è®¿é—®</span>
                    <div class="user-dropdown">
                        <button onclick="logout()" class="logout-btn">é€€å‡ºç™»å½•</button>
                    </div>
                </li>
            </ul>
            <div class="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- ä¼šå‘˜ä¸­å¿ƒå†…å®¹ -->
    <div class="member-container">
        <div class="member-header">
            <h1 id="mainWelcome">æ¬¢è¿æ¥åˆ°ä¼šå‘˜ä¸­å¿ƒ</h1>
            <p>ä¸“å±èµ„æº Â· ä¸ªæ€§æœåŠ¡ Â· æˆé•¿è®°å½•</p>
        </div>
        
        <!-- SupabaseçŠ¶æ€æç¤º -->
        <div id="supabaseStatus" class="init-status" style="display: none;">
            <p>æ•°æ®åº“çŠ¶æ€ï¼š<span id="statusText">æ£€æµ‹ä¸­...</span></p>
        </div>

        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <div class="user-info-card">
            <h2>ä¸ªäººä¿¡æ¯</h2>
            <div class="info-grid">
                <div class="info-item">
                    <strong>å§“åï¼š</strong>
                    <span id="userName">åŠ è½½ä¸­...</span>
                </div>
                <div class="info-item">
                    <strong>ç­çº§ï¼š</strong>
                    <span id="userGrade">åŠ è½½ä¸­...</span>
                </div>
                <div class="info-item">
                    <strong>è§’è‰²ï¼š</strong>
                    <span id="userRole">åŠ è½½ä¸­...</span>
                </div>
                <div class="info-item">
                    <strong>ç™»å½•æ—¶é—´ï¼š</strong>
                    <span id="loginTime">åŠ è½½ä¸­...</span>
                </div>
            </div>
            
            <div id="adminAccess" style="margin-top: 20px;"></div>
        </div>

        <!-- ä¼šå‘˜ä¸“å±åŠŸèƒ½ -->
        <div class="member-features">
            <div class="feature-card">
                <div class="feature-icon">ğŸ“š</div>
                <h3>å­¦ä¹ èµ„æº</h3>
                <p>è®¿é—®ä¸“å±æ•™ç¨‹ã€é¡¹ç›®èµ„æ–™å’Œç«èµ›æŒ‡å—</p>
                <button class="btn btn-primary" onclick="accessResources()">è¿›å…¥èµ„æºåº“</button>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">ğŸ¯</div>
                <h3>é¡¹ç›®ç®¡ç†</h3>
                <p>ç®¡ç†ä¸ªäººé¡¹ç›®ï¼Œè·Ÿè¸ªè¿›åº¦ï¼Œè·å¾—æŒ‡å¯¼</p>
                <button class="btn btn-primary" onclick="manageProjects()">æˆ‘çš„é¡¹ç›®</button>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">ğŸ“Š</div>
                <h3>æˆé•¿è®°å½•</h3>
                <p>æŸ¥çœ‹å‚ä¸æ´»åŠ¨ã€è·å¾—æˆå°±å’ŒæŠ€èƒ½æˆé•¿</p>
                <button class="btn btn-primary" onclick="viewProgress()">æŸ¥çœ‹è®°å½•</button>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>å“ç„¶åˆ›å®¢ç¤¾å›¢</h3>
                    <p>æ­¦å¨ç¬¬åå…«ä¸­å­¦</p>
                    <p>åœ°å€ï¼šç”˜è‚ƒçœæ­¦å¨å¸‚å‡‰å·åŒºå‡¤å‡°è·¯163å·</p>
                </div>
                <div class="footer-section">
                    <h3>å¿«é€Ÿé“¾æ¥</h3>
                    <ul>
                        <li><a href="index.html">é¦–é¡µ</a></li>
                        <li><a href="about.html">å…³äºæˆ‘ä»¬</a></li>
                        <li><a href="activities.html">æ´»åŠ¨å±•ç¤º</a></li>
                        <li><a href="projects.html">é¡¹ç›®æˆæœ</a></li>
                        <li><a href="join.html">åŠ å…¥æˆ‘ä»¬</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>è”ç³»æˆ‘ä»¬</h3>
                    <p>é‚®ç®±ï¼š2959665467@qq.com</p>
                    <p>ç”µè¯ï¼š17793528289</p>
                    <p>æŒ‡å¯¼è€å¸ˆï¼šå¼ è€å¸ˆ</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 æ­¦å¨ç¬¬åå…«ä¸­å­¦å“ç„¶åˆ›å®¢ç¤¾å›¢. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Supabaseé…ç½®
        const SUPABASE_CONFIG = {
            url: 'https://wxbemuwgiiucdgmbhbvg.supabase.co',
            key: 'sb_publishable_KuzTRmYOZ9P6UmKgmb_VwA_6Qj_A6Nk'
        };
        
        let supabase = null;
        let currentUser = null;
        
        // åˆå§‹åŒ–Supabase
        async function initSupabase() {
            try {
                if (!window.supabase || typeof window.supabase.createClient !== 'function') {
                    throw new Error('Supabase SDKæœªåŠ è½½');
                }
                
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                console.log('âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('âŒ Supabaseåˆå§‹åŒ–å¤±è´¥:', error);
                return false;
            }
        }
        
        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        async function testDatabaseConnection() {
            try {
                if (!supabase) {
                    await initSupabase();
                }
                
                const { data, error } = await supabase
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    if (error.code === 'PGRST205' || error.message.includes('Could not find')) {
                        return { success: false, message: 'usersè¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆåœ¨Supabaseä¸­åˆ›å»º' };
                    }
                    throw error;
                }
                
                return { success: true, message: 'æ•°æ®åº“è¿æ¥æ­£å¸¸' };
            } catch (error) {
                console.error('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                return { 
                    success: false, 
                    message: 'æ•°æ®åº“è¿æ¥å¤±è´¥: ' + error.message 
                };
            }
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, isSuccess = false) {
            const statusDiv = document.getElementById('supabaseStatus');
            const statusText = document.getElementById('statusText');
            
            if (statusDiv && statusText) {
                statusDiv.style.display = 'block';
                statusDiv.className = isSuccess ? 'init-status init-success' : 'init-status init-warning';
                statusText.textContent = message;
                
                // å¦‚æœæ˜¯è­¦å‘Šï¼Œ5ç§’åè‡ªåŠ¨éšè—
                if (!isSuccess) {
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }
        
        // ä»æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯
        async function fetchUserFromDatabase(username) {
            try {
                if (!supabase) {
                    await initSupabase();
                }
                
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        console.log('ç”¨æˆ·ä¸åœ¨æ•°æ®åº“ä¸­ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨æ•°æ®');
                        return null;
                    }
                    throw error;
                }
                
                return data;
            } catch (error) {
                console.error('ä»æ•°æ®åº“è·å–ç”¨æˆ·å¤±è´¥:', error);
                return null;
            }
        }
        
        // å®‰å…¨æ›´æ–°å…ƒç´ æ–‡æœ¬
        function updateElementText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            }
        }
        
        // å®‰å…¨æ›´æ–°HTML
        function updateElementHTML(elementId, html) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = html;
            }
        }
        
        // ä¸»åˆå§‹åŒ–å‡½æ•°
        async function initializeMemberPage() {
            console.log('ä¼šå‘˜ä¸­å¿ƒé¡µé¢åˆå§‹åŒ–...');
            
            // 1. æ£€æŸ¥ç™»å½•çŠ¶æ€
            const localUser = sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser');
            
            if (!localUser) {
                alert('è¯·å…ˆç™»å½•ï¼');
                window.location.href = 'index.html';
                return;
            }
            
            // 2. åˆå§‹åŒ–Supabase
            const supabaseInitialized = await initSupabase();
            if (!supabaseInitialized) {
                updateStatus('æ•°æ®åº“è¿æ¥åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', false);
            } else {
                // 3. æµ‹è¯•æ•°æ®åº“è¿æ¥
                const dbTest = await testDatabaseConnection();
                updateStatus(dbTest.message, dbTest.success);
            }
            
            try {
                // 4. è§£ææœ¬åœ°ç”¨æˆ·æ•°æ®
                const user = JSON.parse(localUser);
                const username = sessionStorage.getItem('username') || localStorage.getItem('username');
                const loginTime = sessionStorage.getItem('loginTime') || localStorage.getItem('loginTime') || 'åˆšåˆš';
                
                // 5. å°è¯•ä»æ•°æ®åº“è·å–æœ€æ–°ä¿¡æ¯
                let userData = user;
                if (supabase) {
                    const dbUser = await fetchUserFromDatabase(username);
                    if (dbUser) {
                        userData = dbUser;
                        console.log('ä½¿ç”¨æ•°æ®åº“ç”¨æˆ·æ•°æ®:', userData);
                    } else {
                        console.log('ä½¿ç”¨æœ¬åœ°å­˜å‚¨ç”¨æˆ·æ•°æ®');
                    }
                }
                
                // 6. æ›´æ–°é¡µé¢æ˜¾ç¤º
                updateElementText('userWelcome', `æ¬¢è¿ï¼Œ${userData.name || username}`);
                updateElementText('mainWelcome', `æ¬¢è¿å›æ¥ï¼Œ${userData.name || username}ï¼`);
                updateElementText('userName', userData.name || 'æœªè®¾ç½®');
                updateElementText('userGrade', userData.class || userData.grade || 'æœªè®¾ç½®');
                
                // è§’è‰²è½¬æ¢
                const roleMap = {
                    'admin': 'ç®¡ç†å‘˜',
                    'teacher': 'æ•™å¸ˆ',
                    'student': 'å­¦ç”Ÿ'
                };
                updateElementText('userRole', roleMap[userData.role] || userData.role || 'å­¦ç”Ÿ');
                
                // æ ¼å¼åŒ–æ—¶é—´
                let displayTime = loginTime;
                if (loginTime === 'åˆšåˆš' || loginTime === 'åˆšåˆšç™»å½•') {
                    displayTime = 'åˆšåˆš';
                } else {
                    try {
                        const time = new Date(loginTime);
                        displayTime = time.toLocaleString('zh-CN');
                    } catch (e) {
                        displayTime = loginTime;
                    }
                }
                updateElementText('loginTime', displayTime);
                
                // 7. å¦‚æœæ˜¯ç®¡ç†å‘˜/æ•™å¸ˆï¼Œæ˜¾ç¤ºç®¡ç†å…¥å£
                if (userData.role === 'admin' || userData.role === 'teacher') {
                    updateElementHTML('adminAccess', 
                        '<a href="admin-panel.html" class="btn btn-warning">âš™ï¸ ç®¡ç†åå°</a>');
                }
                
                // ä¿å­˜å½“å‰ç”¨æˆ·å¯¹è±¡åˆ°å…¨å±€
                window.currentUser = userData;
                
            } catch (error) {
                console.error('å¤„ç†ç”¨æˆ·æ•°æ®æ—¶å‡ºé”™:', error);
                updateStatus('ç”¨æˆ·æ•°æ®åŠ è½½å¼‚å¸¸: ' + error.message, false);
                
                // æ˜¾ç¤ºåŸºæœ¬é”™è¯¯ä¿¡æ¯
                updateElementText('userName', 'æ•°æ®åŠ è½½å¤±è´¥');
                updateElementText('userGrade', 'è¯·åˆ·æ–°é¡µé¢é‡è¯•');
                updateElementText('userRole', 'æœªçŸ¥');
                updateElementText('loginTime', 'æœªçŸ¥');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', initializeMemberPage);
        
        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                sessionStorage.clear();
                localStorage.removeItem('currentUser');
                localStorage.removeItem('username');
                localStorage.removeItem('loginTime');
                window.location.href = 'index.html';
            }
        }
        
        // ä¼šå‘˜åŠŸèƒ½å‡½æ•°
        function accessResources() {
            alert('èµ„æºåº“åŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        function manageProjects() {
            alert('é¡¹ç›®ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        function viewProgress() {
            alert('æˆé•¿è®°å½•åŠŸèƒ½å¼€å‘ä¸­...');
        }
    </script>
</body>
</html>
