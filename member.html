<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šå‘˜ä¸­å¿ƒ - æ­¦å¨ç¬¬åå…«ä¸­å­¦å“ç„¶åˆ›å®¢ç¤¾å›¢</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <!-- å¼•å…¥Supabaseå®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .member-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .member-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .user-info-card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .member-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .feature-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        .status-message {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }
        
        .status-success {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2><a href="index.html" style="color: white; text-decoration: none;">å“ç„¶åˆ›å®¢</a></h2>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">é¦–é¡µ</a></li>
                <li><a href="about.html">å…³äºæˆ‘ä»¬</a></li>
                <li><a href="activities.html">æ´»åŠ¨å±•ç¤º</a></li>
                <li><a href="projects.html">é¡¹ç›®æˆæœ</a></li>
                <li><a href="join.html">åŠ å…¥æˆ‘ä»¬</a></li>
                <li class="user-menu">
                    <span id="userWelcome">æ¬¢è¿è®¿é—®</span>
                    <div class="user-dropdown">
                        <button onclick="logout()" class="logout-btn">é€€å‡ºç™»å½•</button>
                    </div>
                </li>
            </ul>
            <div class="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- ä¼šå‘˜ä¸­å¿ƒå†…å®¹ -->
    <div class="member-container">
        <div class="member-header">
            <h1 id="mainWelcome">æ¬¢è¿æ¥åˆ°ä¼šå‘˜ä¸­å¿ƒ</h1>
            <p>ä¸“å±èµ„æº Â· ä¸ªæ€§æœåŠ¡ Â· æˆé•¿è®°å½•</p>
        </div>
        
        <!-- æ•°æ®åº“çŠ¶æ€ -->
        <div id="dbStatus" class="status-message" style="display: none;"></div>
        
        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <div id="loading" class="loading" style="display: none;">
            <p>æ­£åœ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯...</p>
        </div>

        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <div class="user-info-card">
            <h2>ä¸ªäººä¿¡æ¯</h2>
            <div class="info-grid">
                <div class="info-item">
                    <strong>å§“åï¼š</strong>
                    <span id="userName">åŠ è½½ä¸­...</span>
                </div>
                <div class="info-item">
                    <strong>ç­çº§ï¼š</strong>
                    <span id="userGrade">åŠ è½½ä¸­...</span>
                </div>
                <div class="info-item">
                    <strong>è§’è‰²ï¼š</strong>
                    <span id="userRole">åŠ è½½ä¸­...</span>
                </div>
                <div class="info-item">
                    <strong>ç™»å½•æ—¶é—´ï¼š</strong>
                    <span id="loginTime">åŠ è½½ä¸­...</span>
                </div>
            </div>
            
            <div id="adminAccess" style="margin-top: 20px; display: none;"></div>
        </div>

        <!-- ä¼šå‘˜ä¸“å±åŠŸèƒ½ -->
        <div class="member-features">
            <div class="feature-card">
                <div class="feature-icon">ğŸ“š</div>
                <h3>å­¦ä¹ èµ„æº</h3>
                <p>è®¿é—®ä¸“å±æ•™ç¨‹ã€é¡¹ç›®èµ„æ–™å’Œç«èµ›æŒ‡å—</p>
                <button class="btn btn-primary" onclick="accessResources()">è¿›å…¥èµ„æºåº“</button>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">ğŸ¯</div>
                <h3>é¡¹ç›®ç®¡ç†</h3>
                <p>ç®¡ç†ä¸ªäººé¡¹ç›®ï¼Œè·Ÿè¸ªè¿›åº¦ï¼Œè·å¾—æŒ‡å¯¼</p>
                <button class="btn btn-primary" onclick="manageProjects()">æˆ‘çš„é¡¹ç›®</button>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">ğŸ“Š</div>
                <h3>æˆé•¿è®°å½•</h3>
                <p>æŸ¥çœ‹å‚ä¸æ´»åŠ¨ã€è·å¾—æˆå°±å’ŒæŠ€èƒ½æˆé•¿</p>
                <button class="btn btn-primary" onclick="viewProgress()">æŸ¥çœ‹è®°å½•</button>
            </div>
        </div>
    </div>

    <!-- ç­¾åˆ°åŠŸèƒ½å¡ç‰‡ -->
<div class="feature-card">
    <div class="feature-icon">ğŸ“…</div>
    <h3>æ¯æ—¥ç­¾åˆ°</h3>
    <div id="signinStatus">
        <p>è¿ç»­ç­¾åˆ°: <span id="continuousDays">0</span> å¤©</p>
        <p>ä»Šæ—¥ç§¯åˆ†: <span id="todayPoints">0</span> åˆ†</p>
    </div>
    <button id="signinBtn" class="btn btn-primary" onclick="handleSignIn()">ç‚¹å‡»ç­¾åˆ°</button>
    <div id="signinCalendar" style="margin-top: 15px;">
        <h4>æœ¬æœˆç­¾åˆ°æ—¥å†</h4>
        <div id="calendarContainer" class="calendar-grid"></div>
    </div>
</div>

<style>
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-top: 10px;
}
.calendar-day {
    padding: 8px;
    text-align: center;
    border-radius: 50%;
    background: #f0f0f0;
}
.calendar-day.signed {
    background: #4CAF50;
    color: white;
}
.calendar-day.today {
    border: 2px solid #2196F3;
}
.signin-animation {
    animation: bounce 0.6s;
}
@keyframes bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
</style>
    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>å“ç„¶åˆ›å®¢ç¤¾å›¢</h3>
                    <p>æ­¦å¨ç¬¬åå…«ä¸­å­¦</p>
                    <p>åœ°å€ï¼šç”˜è‚ƒçœæ­¦å¨å¸‚å‡‰å·åŒºå‡¤å‡°è·¯163å·</p>
                </div>
                <div class="footer-section">
                    <h3>å¿«é€Ÿé“¾æ¥</h3>
                    <ul>
                        <li><a href="index.html">é¦–é¡µ</a></li>
                        <li><a href="about.html">å…³äºæˆ‘ä»¬</a></li>
                        <li><a href="activities.html">æ´»åŠ¨å±•ç¤º</a></li>
                        <li><a href="projects.html">é¡¹ç›®æˆæœ</a></li>
                        <li><a href="join.html">åŠ å…¥æˆ‘ä»¬</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>è”ç³»æˆ‘ä»¬</h3>
                    <p>é‚®ç®±ï¼š2959665467@qq.com</p>
                    <p>ç”µè¯ï¼š17793528289</p>
                    <p>æŒ‡å¯¼è€å¸ˆï¼šå¼ è€å¸ˆ</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 æ­¦å¨ç¬¬åå…«ä¸­å­¦å“ç„¶åˆ›å®¢ç¤¾å›¢. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // ==================== æ ¸å¿ƒä»£ç  - ä¿®å¤é‡å¤å£°æ˜é—®é¢˜ ====================
        
        // ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°é¿å…å˜é‡å†²çª
        (function() {
            'use strict';
            
            // Supabaseé…ç½®
            const SUPABASE_CONFIG = {
                url: 'https://wxbemuwgiiucdgmbhbvg.supabase.co',
                key: 'sb_publishable_KuzTRmYOZ9P6UmKgmb_VwA_6Qj_A6Nk'
            };
            
            // å…¨å±€å˜é‡å£°æ˜
            let supabaseClient = null;  // ä½¿ç”¨ä¸åŒåç§°é¿å…å†²çª
            let currentUser = null;
            
            // DOMå…ƒç´ å¼•ç”¨
            let dbStatusEl, loadingEl, userNameEl, userGradeEl, userRoleEl, loginTimeEl, adminAccessEl;
            
            // é¡µé¢åˆå§‹åŒ–
            document.addEventListener('DOMContentLoaded', async function() {
                console.log('ä¼šå‘˜ä¸­å¿ƒé¡µé¢åˆå§‹åŒ–...');
                
                // è·å–DOMå…ƒç´ 
                dbStatusEl = document.getElementById('dbStatus');
                loadingEl = document.getElementById('loading');
                userNameEl = document.getElementById('userName');
                userGradeEl = document.getElementById('userGrade');
                userRoleEl = document.getElementById('userRole');
                loginTimeEl = document.getElementById('loginTime');
                adminAccessEl = document.getElementById('adminAccess');
                
                // 1. æ£€æŸ¥ç™»å½•çŠ¶æ€
                if (!checkLoginStatus()) {
                    return;
                }
                
                // 2. åˆå§‹åŒ–Supabase
                const initialized = await initSupabase();
                if (!initialized) {
                    // ä½¿ç”¨æœ¬åœ°æ•°æ®
                    displayUserFromLocalStorage();
                    return;
                }
                
                // 3. ä»æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯
                await fetchAndDisplayUser();
                
            });
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            function checkLoginStatus() {
                const username = sessionStorage.getItem('username') || localStorage.getItem('username');
                const userData = sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser');
                
                if (!username || !userData) {
                    alert('è¯·å…ˆç™»å½•ï¼');
                    window.location.href = 'index.html';
                    return false;
                }
                
                return true;
            }
            
            // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
            async function initSupabase() {
                try {
                    showLoading(true);
                    showStatus('æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“è¿æ¥...', 'warning');
                    
                    // æ£€æŸ¥Supabase SDKæ˜¯å¦åŠ è½½
                    if (typeof window.supabase === 'undefined') {
                        showStatus('Supabase SDKæœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                        return false;
                    }
                    
                    // åˆ›å»ºSupabaseå®¢æˆ·ç«¯å®ä¾‹
                    supabaseClient = window.supabase.createClient(
                        SUPABASE_CONFIG.url,
                        SUPABASE_CONFIG.key
                    );
                    
                    // æµ‹è¯•è¿æ¥
                    const { error } = await supabaseClient
                        .from('users')
                        .select('count')
                        .limit(1);
                    
                    if (error) {
                        if (error.code === 'PGRST205') {
                            showStatus('æ•°æ®åº“è¡¨æœªåˆ›å»ºï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®æ¨¡å¼', 'warning');
                        } else {
                            showStatus('æ•°æ®åº“è¿æ¥å¼‚å¸¸: ' + error.message, 'error');
                        }
                        return false;
                    }
                    
                    showStatus('æ•°æ®åº“è¿æ¥æˆåŠŸ', 'success');
                    return true;
                    
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    showStatus('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                    return false;
                } finally {
                    showLoading(false);
                }
            }
            
            // ä»æ•°æ®åº“è·å–å¹¶æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            async function fetchAndDisplayUser() {
                try {
                    showLoading(true);
                    
                    const username = sessionStorage.getItem('username') || localStorage.getItem('username');
                    
                    if (!supabaseClient) {
                        throw new Error('æ•°æ®åº“è¿æ¥æœªå°±ç»ª');
                    }
                    
                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('username', username)
                        .single();
                    
                    if (error) {
                        if (error.code === 'PGRST116') {
                            // ç”¨æˆ·ä¸åœ¨æ•°æ®åº“ä¸­
                            console.log('ç”¨æˆ·ä¸åœ¨æ•°æ®åº“ä¸­ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                            displayUserFromLocalStorage();
                            return;
                        }
                        throw error;
                    }
                    
                    // ä½¿ç”¨æ•°æ®åº“ä¸­çš„ç”¨æˆ·æ•°æ®
                    displayUser(data, true);
                    
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    showStatus('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
                    displayUserFromLocalStorage();
                } finally {
                    showLoading(false);
                }
            }
            
            // ä»æœ¬åœ°å­˜å‚¨æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            function displayUserFromLocalStorage() {
                try {
                    const userData = sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser');
                    const username = sessionStorage.getItem('username') || localStorage.getItem('username');
                    
                    if (!userData) {
                        throw new Error('æœ¬åœ°ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨');
                    }
                    
                    const user = JSON.parse(userData);
                    displayUser(user, false);
                    
                } catch (error) {
                    console.error('æ˜¾ç¤ºæœ¬åœ°ç”¨æˆ·å¤±è´¥:', error);
                    showStatus('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
                    
                    // æ˜¾ç¤ºé»˜è®¤å€¼
                    userNameEl.textContent = 'æ•°æ®åŠ è½½å¤±è´¥';
                    userGradeEl.textContent = 'è¯·é‡æ–°ç™»å½•';
                    userRoleEl.textContent = 'æœªçŸ¥';
                    loginTimeEl.textContent = '--';
                }
            }
            
            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            function displayUser(user, fromDatabase = false) {
                try {
                    // æ›´æ–°æ¬¢è¿ä¿¡æ¯
                    const welcomeEl = document.getElementById('userWelcome');
                    const mainWelcomeEl = document.getElementById('mainWelcome');
                    
                    if (welcomeEl) {
                        welcomeEl.textContent = `æ¬¢è¿ï¼Œ${user.name || user.username || 'ç”¨æˆ·'}`;
                    }
                    if (mainWelcomeEl) {
                        mainWelcomeEl.textContent = `æ¬¢è¿å›æ¥ï¼Œ${user.name || user.username || 'ç”¨æˆ·'}ï¼`;
                    }
                    
                    // æ›´æ–°åŸºæœ¬ä¿¡æ¯
                    userNameEl.textContent = user.name || 'æœªè®¾ç½®';
                    userGradeEl.textContent = user.class || user.grade || 'æœªè®¾ç½®';
                    
                    // è§’è‰²è½¬æ¢
                    const roleMap = {
                        'admin': 'ç®¡ç†å‘˜',
                        'teacher': 'æ•™å¸ˆ',
                        'student': 'å­¦ç”Ÿ'
                    };
                    userRoleEl.textContent = roleMap[user.role] || user.role || 'å­¦ç”Ÿ';
                    
                    // ç™»å½•æ—¶é—´
                    const loginTime = sessionStorage.getItem('loginTime') || localStorage.getItem('loginTime') || 'åˆšåˆš';
                    loginTimeEl.textContent = formatTime(loginTime);
                    
                    // ç®¡ç†å‘˜/æ•™å¸ˆæƒé™
                    if (user.role === 'admin' || user.role === 'teacher') {
                        adminAccessEl.style.display = 'block';
                        adminAccessEl.innerHTML = '<a href="admin-panel.html" class="btn btn-warning" style="background: #ffc107; color: #212529; padding: 8px 16px; border-radius: 4px; text-decoration: none;">âš™ï¸ ç®¡ç†åå°</a>';
                    }
                    
                    // ä¿å­˜åˆ°å…¨å±€
                    window.currentUser = user;
                    
                    if (fromDatabase) {
                        showStatus('ç”¨æˆ·ä¿¡æ¯å·²ä»æ•°æ®åº“åŠ è½½', 'success');
                    } else {
                        showStatus('ä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯', 'warning');
                    }
                    
                } catch (error) {
                    console.error('æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    showStatus('æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯æ—¶å‡ºé”™', 'error');
                }
            }
            
            // å·¥å…·å‡½æ•°
            function showStatus(message, type = 'info') {
                if (!dbStatusEl) return;
                
                dbStatusEl.style.display = 'block';
                dbStatusEl.textContent = message;
                dbStatusEl.className = 'status-message';
                
                switch (type) {
                    case 'success':
                        dbStatusEl.classList.add('status-success');
                        break;
                    case 'warning':
                        dbStatusEl.classList.add('status-warning');
                        break;
                    case 'error':
                        dbStatusEl.classList.add('status-error');
                        break;
                }
                
                // è‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
                if (type === 'success') {
                    setTimeout(() => {
                        dbStatusEl.style.display = 'none';
                    }, 3000);
                }
            }
            
            function showLoading(show) {
                if (!loadingEl) return;
                loadingEl.style.display = show ? 'block' : 'none';
            }
            
            function formatTime(timeString) {
                if (!timeString || timeString === 'åˆšåˆš') {
                    return 'åˆšåˆš';
                }
                
                try {
                    const time = new Date(timeString);
                    if (isNaN(time.getTime())) {
                        return timeString;
                    }
                    return time.toLocaleString('zh-CN');
                } catch (e) {
                    return timeString;
                }
            }
            
            // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.logout = function() {
                if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                    sessionStorage.clear();
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('username');
                    localStorage.removeItem('loginTime');
                    window.location.href = 'index.html';
                }
            };
            
            window.accessResources = function() {
                alert('èµ„æºåº“åŠŸèƒ½å¼€å‘ä¸­...');
            };
            
            window.manageProjects = function() {
                alert('é¡¹ç›®ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...');
            };
            
            window.viewProgress = function() {
                alert('æˆé•¿è®°å½•åŠŸèƒ½å¼€å‘ä¸­...');
            };
            
        })(); // ç«‹å³æ‰§è¡Œå‡½æ•°ç»“æŸ
    </script>
</body>
</html>
