<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¦å·ç®¡ç†ç³»ç»Ÿ - å“ç„¶åˆ›å®¢ç¤¾å›¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        .admin-header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .admin-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .welcome-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
            display: block;
        }
        
        .admin-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
        }
        
        .section-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section-card h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #3498db;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Microsoft YaHei', monospace;
            font-size: 0.9rem;
            resize: vertical;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .user-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            padding: 0.3rem 0.8rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .search-box {
            margin-bottom: 1rem;
        }
        
        .search-box input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .message {
            padding: 0.75rem;
            border-radius: 5px;
            margin: 1rem 0;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .import-format {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        
        .import-format code {
            background: #e9ecef;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- ç®¡ç†å‘˜å¤´éƒ¨ -->
    <header class="admin-header">
        <h1>å“ç„¶åˆ›å®¢ç¤¾å›¢ - è´¦å·ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="admin-info">
            <span id="adminWelcome">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="admin-container">
        <!-- æ¬¢è¿æ¨ªå¹… -->
        <div class="welcome-banner">
            <h2 id="mainWelcome">ç®¡ç†å‘˜æ§åˆ¶å°</h2>
            <p>ç®¡ç†ç³»ç»Ÿè´¦å·å’Œæƒé™</p>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number" id="totalUsers">0</span>
                <span>æ€»ç”¨æˆ·æ•°</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="studentUsers">0</span>
                <span>å­¦ç”Ÿç”¨æˆ·</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="teacherUsers">0</span>
                <span>æ•™å¸ˆç”¨æˆ·</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="todayLogins">0</span>
                <span>ä»Šæ—¥ç™»å½•</span>
            </div>
        </div>
        
        <!-- åŠŸèƒ½åŒºåŸŸ -->
        <div class="admin-sections">
            <!-- æ‰¹é‡å¯¼å…¥åŒºåŸŸ -->
            <div class="section-card">
                <h3>ğŸ“¥ æ‰¹é‡å¯¼å…¥è´¦å·</h3>
                
                <div class="import-format">
                    <strong>å¯¼å…¥æ ¼å¼è¯´æ˜ï¼š</strong><br>
                    æ¯è¡Œä¸€ä¸ªè´¦å·ï¼Œæ ¼å¼ï¼š<code>å­¦å·,å§“å,ç­çº§,åˆå§‹å¯†ç (å¯é€‰)</code><br>
                    ç¤ºä¾‹ï¼š<br>
                    <code>2023001,å¼ ä¸‰,é«˜ä¸€(1)ç­,123456</code><br>
                    <code>2023002,æå››,é«˜ä¸€(1)ç­</code> (é»˜è®¤å¯†ç ï¼š123456)<br>
                    <code>teacher01,å¼ è€å¸ˆ,æŒ‡å¯¼æ•™å¸ˆ,teacher123</code>
                </div>
                
                <textarea id="importData" placeholder="è¯·æŒ‰ç…§ä¸Šè¿°æ ¼å¼è¾“å…¥è´¦å·ä¿¡æ¯..."></textarea>
                
                <div>
                    <button class="btn btn-success" onclick="importAccounts()">å¯¼å…¥è´¦å·</button>
                    <button class="btn" onclick="generateSample()">ç”Ÿæˆç¤ºä¾‹æ•°æ®</button>
                    <button class="btn" onclick="clearImport()">æ¸…ç©ºè¾“å…¥</button>
                </div>
                
                <div id="importMessage" class="message"></div>
            </div>
            
            <!-- ç”¨æˆ·ç®¡ç†åŒºåŸŸ -->
            <div class="section-card">
                <h3>ğŸ‘¥ ç”¨æˆ·è´¦å·ç®¡ç†</h3>
                
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="æœç´¢å­¦å·ã€å§“åæˆ–ç­çº§..." onkeyup="searchUsers()">
                </div>
                
                <div class="user-actions">
                    <button class="btn btn-danger" onclick="deleteAllUsers()">åˆ é™¤æ‰€æœ‰ç”¨æˆ·</button>
                    <button class="btn" onclick="exportUsers()">å¯¼å‡ºç”¨æˆ·æ•°æ®</button>
                    <button class="btn" onclick="resetAllPasswords()">é‡ç½®æ‰€æœ‰å¯†ç </button>
                </div>
                
                <div class="user-list" id="userList">
                    <!-- ç”¨æˆ·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- å•ä¸ªè´¦å·æ“ä½œåŒºåŸŸ -->
            <div class="section-card">
                <h3>â• å•ä¸ªè´¦å·æ“ä½œ</h3>
                
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <label>å­¦å·/è´¦å·ï¼š</label>
                        <input type="text" id="singleUsername" placeholder="è¯·è¾“å…¥å­¦å·æˆ–è´¦å·">
                    </div>
                    <div>
                        <label>å§“åï¼š</label>
                        <input type="text" id="singleName" placeholder="è¯·è¾“å…¥å§“å">
                    </div>
                    <div>
                        <label>ç­çº§/èº«ä»½ï¼š</label>
                        <input type="text" id="singleGrade" placeholder="ä¾‹å¦‚ï¼šé«˜ä¸€(1)ç­ æˆ– æŒ‡å¯¼æ•™å¸ˆ">
                    </div>
                    <div>
                        <label>å¯†ç ï¼š</label>
                        <input type="text" id="singlePassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆé»˜è®¤ï¼š123456ï¼‰">
                    </div>
                </div>
                
                <div style="margin-top: 1rem;">
                    <button class="btn btn-success" onclick="addSingleUser()">æ·»åŠ ç”¨æˆ·</button>
                    <button class="btn" onclick="findUser()">æŸ¥æ‰¾ç”¨æˆ·</button>
                    <button class="btn btn-danger" onclick="deleteUser()">åˆ é™¤ç”¨æˆ·</button>
                    <button class="btn" onclick="resetUserPassword()">é‡ç½®å¯†ç </button>
                </div>
                
                <div id="singleUserMessage" class="message"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let allUsers = {};
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadUsers();
            updateStats();
            displayAdminInfo();
        });
        
        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        function checkAdminAuth() {
            const adminUser = sessionStorage.getItem('adminUser');
            if (!adminUser) {
                alert('è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·ï¼');
                window.location.href = 'admin-login.html';
                return;
            }
        }
        
        // æ˜¾ç¤ºç®¡ç†å‘˜ä¿¡æ¯
        function displayAdminInfo() {
            const adminUser = JSON.parse(sessionStorage.getItem('adminUser'));
            const loginTime = sessionStorage.getItem('adminLoginTime');
            
            document.getElementById('adminWelcome').textContent = `æ¬¢è¿ï¼Œ${adminUser.name}`;
            document.getElementById('mainWelcome').textContent = `${adminUser.name}çš„æ§åˆ¶å°`;
        }
        
        // åŠ è½½ç”¨æˆ·æ•°æ®
        function loadUsers() {
            // ä»localStorageåŠ è½½æ³¨å†Œç”¨æˆ·
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
            
            // åˆå¹¶é¢„è®¾ç”¨æˆ·ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const presetUsers = {
                '2023001': { password: '123456', name: 'å¼ ä¸‰', grade: 'é«˜ä¸€(1)ç­', role: 'student' },
                'admin': { password: 'admin123', name: 'ç®¡ç†å‘˜', grade: 'ç³»ç»Ÿç®¡ç†', role: 'admin' }
            };
            
            allUsers = { ...presetUsers, ...registeredUsers };
            displayUserList();
        }
        
        // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
        function displayUserList(filteredUsers = null) {
            const usersToShow = filteredUsers || allUsers;
            const userList = document.getElementById('userList');
            
            if (Object.keys(usersToShow).length === 0) {
                userList.innerHTML = '<div class="user-item">æš‚æ— ç”¨æˆ·æ•°æ®</div>';
                return;
            }
            
            userList.innerHTML = Object.keys(usersToShow).map(username => {
                const user = usersToShow[username];
                return `
                    <div class="user-item">
                        <div class="user-info">
                            <strong>${username}</strong> - ${user.name} (${user.grade})
                            ${user.role === 'admin' ? '<span style="color: #e74c3c;">[ç®¡ç†å‘˜]</span>' : ''}
                            ${user.registerTime ? `<br><small>æ³¨å†Œæ—¶é—´: ${user.registerTime}</small>` : ''}
                        </div>
                        <div class="user-actions">
                            <button class="action-btn" style="background: #3498db; color: white;" 
                                    onclick="editUser('${username}')">ç¼–è¾‘</button>
                            <button class="action-btn" style="background: #e74c3c; color: white;" 
                                    onclick="deleteSingleUser('${username}')">åˆ é™¤</button>
                            <button class="action-btn" style="background: #f39c12; color: white;" 
                                    onclick="resetSinglePassword('${username}')">é‡ç½®å¯†ç </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const studentCount = Object.values(allUsers).filter(user => user.role === 'student').length;
            const teacherCount = Object.values(allUsers).filter(user => user.role === 'teacher' || user.role === 'admin').length;
            
            document.getElementById('totalUsers').textContent = Object.keys(allUsers).length;
            document.getElementById('studentUsers').textContent = studentCount;
            document.getElementById('teacherUsers').textContent = teacherCount;
            document.getElementById('todayLogins').textContent = '0'; // ç®€åŒ–å¤„ç†
        }
        
        // æ‰¹é‡å¯¼å…¥è´¦å·
        function importAccounts() {
            const importData = document.getElementById('importData').value.trim();
            if (!importData) {
                showMessage('è¯·è¾“å…¥è¦å¯¼å…¥çš„è´¦å·æ•°æ®ï¼', 'error', 'importMessage');
                return;
            }
            
            const lines = importData.split('\n').filter(line => line.trim());
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            lines.forEach((line, index) => {
                const parts = line.split(',').map(part => part.trim());
                if (parts.length >= 3) {
                    const [username, name, grade, password = '123456'] = parts;
                    
                    if (!allUsers[username]) {
                        allUsers[username] = {
                            password: password,
                            name: name,
                            grade: grade,
                            role: grade.includes('æ•™å¸ˆ') || grade.includes('è€å¸ˆ') || grade.includes('æŒ‡å¯¼') ? 'teacher' : 'student',
                            registerTime: new Date().toLocaleString(),
                            importTime: new Date().toLocaleString()
                        };
                        successCount++;
                    } else {
                        errorCount++;
                        errors.push(`ç¬¬${index + 1}è¡Œ: è´¦å· ${username} å·²å­˜åœ¨`);
                    }
                } else {
                    errorCount++;
                    errors.push(`ç¬¬${index + 1}è¡Œ: æ ¼å¼é”™è¯¯`);
                }
            });
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('registeredUsers', allUsers);
            
            let message = `å¯¼å…¥å®Œæˆï¼æˆåŠŸ: ${successCount}ä¸ª, å¤±è´¥: ${errorCount}ä¸ª`;
            if (errors.length > 0) {
                message += '<br>é”™è¯¯è¯¦æƒ…:<br>' + errors.join('<br>');
            }
            
            showMessage(message, errorCount === 0 ? 'success' : 'warning', 'importMessage');
            
            // æ›´æ–°æ˜¾ç¤º
            displayUserList();
            updateStats();
        }
        
        // æœç´¢ç”¨æˆ·
        function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm) {
                displayUserList();
                return;
            }
            
            const filteredUsers = {};
            Object.keys(allUsers).forEach(username => {
                const user = allUsers[username];
                if (username.toLowerCase().includes(searchTerm) ||
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.grade.toLowerCase().includes(searchTerm)) {
                    filteredUsers[username] = user;
                }
            });
            
            displayUserList(filteredUsers);
        }
        
        // ç”Ÿæˆç¤ºä¾‹æ•°æ®
        function generateSample() {
            const sampleData = `2023001,å¼ ä¸‰,é«˜ä¸€(1)ç­,123456
2023002,æå››,é«˜ä¸€(1)ç­
2023003,ç‹äº”,é«˜ä¸€(2)ç­
2023004,èµµå…­,é«˜ä¸€(3)ç­
teacher01,å¼ è€å¸ˆ,æŒ‡å¯¼æ•™å¸ˆ,teacher123
teacher02,æè€å¸ˆ,æŠ€æœ¯é¡¾é—®,teacher123`;
            
            document.getElementById('importData').value = sampleData;
        }
        
        // æ¸…ç©ºè¾“å…¥
        function clearImport() {
            document.getElementById('importData').value = '';
        }
        
        // æ·»åŠ å•ä¸ªç”¨æˆ·
        function addSingleUser() {
            const username = document.getElementById('singleUsername').value.trim();
            const name = document.getElementById('singleName').value.trim();
            const grade = document.getElementById('singleGrade').value.trim();
            const password = document.getElementById('singlePassword').value.trim() || '123456';
            
            if (!username || !name || !grade) {
                showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼', 'error', 'singleUserMessage');
                return;
            }
            
            if (allUsers[username]) {
                showMessage('è¯¥è´¦å·å·²å­˜åœ¨ï¼', 'error', 'singleUserMessage');
                return;
            }
            
            allUsers[username] = {
                password: password,
                name: name,
                grade: grade,
                role: grade.includes('æ•™å¸ˆ') || grade.includes('è€å¸ˆ') || grade.includes('æŒ‡å¯¼') ? 'teacher' : 'student',
                registerTime: new Date().toLocaleString()
            };
            
            localStorage.setItem('registeredUsers', allUsers);
            showMessage('ç”¨æˆ·æ·»åŠ æˆåŠŸï¼', 'success', 'singleUserMessage');
            clearSingleForm();
            displayUserList();
            updateStats();
        }
        
        // æŸ¥æ‰¾ç”¨æˆ·
        function findUser() {
            const username = document.getElementById('singleUsername').value.trim();
            if (!username) {
                showMessage('è¯·è¾“å…¥è¦æŸ¥æ‰¾çš„è´¦å·ï¼', 'error', 'singleUserMessage');
                return;
            }
            
            if (allUsers[username]) {
                const user = allUsers[username];
                document.getElementById('singleName').value = user.name;
                document.getElementById('singleGrade').value = user.grade;
                document.getElementById('singlePassword').value = '';
                showMessage('æ‰¾åˆ°ç”¨æˆ·ï¼å¯†ç å·²éšè—', 'success', 'singleUserMessage');
            } else {
                showMessage('ç”¨æˆ·ä¸å­˜åœ¨ï¼', 'error', 'singleUserMessage');
            }
        }
        
        // åˆ é™¤ç”¨æˆ·
        function deleteUser() {
            const username = document.getElementById('singleUsername').value.trim();
            if (!username) {
                showMessage('è¯·è¾“å…¥è¦åˆ é™¤çš„è´¦å·ï¼', 'error', 'singleUserMessage');
                return;
            }
            
            if (allUsers[username]) {
                if (confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${username} - ${allUsers[username].name} å—ï¼Ÿ`)) {
                    delete allUsers[username];
                    localStorage.setItem('registeredUsers', allUsers);
                    showMessage('ç”¨æˆ·åˆ é™¤æˆåŠŸï¼', 'success', 'singleUserMessage');
                    clearSingleForm();
                    displayUserList();
                    updateStats();
                }
            } else {
                showMessage('ç”¨æˆ·ä¸å­˜åœ¨ï¼', 'error', 'singleUserMessage');
            }
        }
        
        // é‡ç½®ç”¨æˆ·å¯†ç 
        function resetUserPassword() {
            const username = document.getElementById('singleUsername').value.trim();
            const newPassword = document.getElementById('singlePassword').value.trim() || '123456';
            
            if (!username) {
                showMessage('è¯·è¾“å…¥è´¦å·ï¼', 'error', 'singleUserMessage');
                return;
            }
            
            if (allUsers[username]) {
                allUsers[username].password = newPassword;
                allUsers[username].passwordResetTime = new Date().toLocaleString();
                localStorage.setItem('registeredUsers', allUsers);
                showMessage(`å¯†ç å·²é‡ç½®ä¸º: ${newPassword}`, 'success', 'singleUserMessage');
            } else {
                showMessage('ç”¨æˆ·ä¸å­˜åœ¨ï¼', 'error', 'singleUserMessage');
            }
        }
        
        // æ¸…ç©ºå•ä¸ªæ“ä½œè¡¨å•
        function clearSingleForm() {
            document.getElementById('singleUsername').value = '';
            document.getElementById('singleName').value = '';
            document.getElementById('singleGrade').value = '';
            document.getElementById('singlePassword').value = '';
        }
        
        // åˆ é™¤å•ä¸ªç”¨æˆ·ï¼ˆä»åˆ—è¡¨ï¼‰
        function deleteSingleUser(username) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${username} å—ï¼Ÿ`)) {
                delete allUsers[username];
                localStorage.setItem('registeredUsers', allUsers);
                displayUserList();
                updateStats();
                showMessage('ç”¨æˆ·åˆ é™¤æˆåŠŸï¼', 'success', '
