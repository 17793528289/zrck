<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #333; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
    
    .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
    .stat-value { font-size: 36px; font-weight: bold; margin: 10px 0; }
    
    .panel { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 5px solid #007bff; }
    h2 { color: #495057; margin-bottom: 20px; }
    
    .form-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
    input, select, textarea { flex: 1; min-width: 200px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; }
    button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-danger { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    .btn-success { background: #28a745; color: white; }
    
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
    th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; text-align: left; }
    td { padding: 12px 15px; border-bottom: 1px solid #dee2e6; }
    tr:hover { background-color: #f8f9fa; }
    
    .actions { display: flex; gap: 5px; }
    .action-btn { padding: 5px 10px; font-size: 12px; }
    
    .alert { padding: 15px; border-radius: 5px; margin: 10px 0; display: none; }
    .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    
    .loading { text-align: center; padding: 20px; color: #6c757d; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ‘¨â€ğŸ’¼ ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ</h1>
    
    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div class="dashboard">
      <div class="stat-card">
        <div>æ€»ç”¨æˆ·æ•°</div>
        <div class="stat-value" id="totalUsers">0</div>
      </div>
      <div class="stat-card">
        <div>å­¦ç”Ÿç”¨æˆ·</div>
        <div class="stat-value" id="studentUsers">0</div>
      </div>
      <div class="stat-card">
        <div>æ•™å¸ˆç”¨æˆ·</div>
        <div class="stat-value" id="teacherUsers">0</div>
      </div>
      <div class="stat-card">
        <div>æ´»è·ƒç”¨æˆ·</div>
        <div class="stat-value" id="activeUsers">0</div>
      </div>
    </div>
    
    <!-- æ·»åŠ ç”¨æˆ· -->
    <div class="panel">
      <h2>â• æ·»åŠ ç”¨æˆ·</h2>
      <div id="addAlert" class="alert"></div>
      <div class="form-group">
        <input id="username" placeholder="ç”¨æˆ·å" required>
        <input id="name" placeholder="å§“å" required>
        <input id="class" placeholder="ç­çº§/éƒ¨é—¨" required>
        <input id="password" placeholder="å¯†ç ï¼ˆé»˜è®¤123456ï¼‰" type="password">
        <select id="role">
          <option value="student">å­¦ç”Ÿ</option>
          <option value="teacher">æ•™å¸ˆ</option>
          <option value="admin">ç®¡ç†å‘˜</option>
        </select>
        <button class="btn-primary" onclick="addUser()">æ·»åŠ ç”¨æˆ·</button>
      </div>
    </div>
    
    <!-- æ‰¹é‡å¯¼å…¥ -->
    <div class="panel">
      <h2>ğŸ“¤ æ‰¹é‡å¯¼å…¥</h2>
      <textarea id="batchData" placeholder="è¯·è¾“å…¥CSVæ ¼å¼æ•°æ®ï¼ˆç”¨æˆ·å,å§“å,ç­çº§,å¯†ç (å¯é€‰)ï¼‰" rows="4"></textarea>
      <div class="form-group">
        <button class="btn-secondary" onclick="batchImport()">æ‰¹é‡å¯¼å…¥</button>
        <button class="btn-success" onclick="exportUsers()">å¯¼å‡ºCSV</button>
      </div>
    </div>
    
    <!-- æœç´¢ -->
    <div class="panel">
      <h2>ğŸ” æœç´¢ç”¨æˆ·</h2>
      <div class="form-group">
        <input id="searchInput" placeholder="æœç´¢ç”¨æˆ·åã€å§“åã€ç­çº§..." style="flex: 2;">
        <button class="btn-secondary" onclick="searchUsers()">æœç´¢</button>
        <button onclick="resetSearch()">é‡ç½®</button>
      </div>
    </div>
    
    <!-- ç”¨æˆ·åˆ—è¡¨ -->
    <div class="panel">
      <h2>ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨</h2>
      <div id="tableAlert" class="alert"></div>
      <div id="loading" class="loading">åŠ è½½ä¸­...</div>
      <table id="userTable">
        <thead>
          <tr>
            <th>ç”¨æˆ·å</th>
            <th>å§“å</th>
            <th>ç­çº§/éƒ¨é—¨</th>
            <th>è§’è‰²</th>
            <th>çŠ¶æ€</th>
            <th>åˆ›å»ºæ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // ================== åˆå§‹åŒ–é˜¶æ®µ ==================
    // è§£å†³é”™è¯¯çš„å…³é”®ï¼šåœ¨å£°æ˜å‰ä¸è®¿é—®supabase
    
    // 1. å…ˆå®šä¹‰Supabaseé…ç½®
    const SUPABASE_CONFIG = {
      url: 'https://wxbemuwgiiucdgmbhbvg.supabase.co',
      key: 'sb_publishable_KuzTRmYOZ9P6UmKgmb_VwA_6Qj_A6Nk'
    };
    
    // 2. å£°æ˜å…¨å±€å˜é‡ï¼ˆä¸åˆå§‹åŒ–ï¼‰
    let supabase = null;
    let usersCache = [];
    
    // 3. åˆå§‹åŒ–å‡½æ•°
    async function initSupabase() {
      try {
        if (!window.supabase || typeof window.supabase.createClient !== 'function') {
          throw new Error('Supabase SDKæœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        }
        
        supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
        console.log('âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
        return true;
      } catch (error) {
        console.error('âŒ Supabaseåˆå§‹åŒ–å¤±è´¥:', error);
        showAlert('tableAlert', 'æ•°æ®åº“è¿æ¥å¤±è´¥: ' + error.message, 'error');
        return false;
      }
    }
    
    // 4. é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
      
      // åˆå§‹åŒ–Supabase
      const initialized = await initSupabase();
      if (!initialized) return;
      
      // åŠ è½½ç”¨æˆ·æ•°æ®
      await loadUsers();
      
      // ç»‘å®šäº‹ä»¶
      setupEventListeners();
    });
    
    // ================== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ==================
    
    // åŠ è½½ç”¨æˆ·æ•°æ®
    async function loadUsers() {
      try {
        showLoading(true);
        
        // ç¡®ä¿supabaseå·²åˆå§‹åŒ–
        if (!supabase || typeof supabase.from !== 'function') {
          throw new Error('æ•°æ®åº“è¿æ¥æœªå°±ç»ª');
        }
        
        const { data, error } = await supabase
          .from('users')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        usersCache = data || [];
        renderUserTable(usersCache);
        updateStats(usersCache);
        showAlert('tableAlert', `æˆåŠŸåŠ è½½ ${usersCache.length} ä¸ªç”¨æˆ·`, 'success');
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
        showAlert('tableAlert', 'åŠ è½½ç”¨æˆ·å¤±è´¥: ' + error.message, 'error');
        renderUserTable([]);
      } finally {
        showLoading(false);
      }
    }
    
    // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
    function renderUserTable(users) {
      const tbody = document.querySelector('#userTable tbody');
      tbody.innerHTML = '';
      
      if (!users || users.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">
              <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</div>
              <div>æš‚æ— ç”¨æˆ·æ•°æ®</div>
            </td>
          </tr>
        `;
        return;
      }
      
      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${user.username || '-'}</td>
          <td>${user.name || '-'}</td>
          <td>${user.class || '-'}</td>
          <td><span class="role-badge">${getRoleLabel(user.role)}</span></td>
          <td><span class="status-badge ${user.status ? 'active' : 'inactive'}">${user.status ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</span></td>
          <td>${formatDate(user.created_at)}</td>
          <td>
            <div class="actions">
              <button class="action-btn" onclick="editUser('${user.id}')">ç¼–è¾‘</button>
              <button class="action-btn" onclick="toggleUserStatus('${user.id}', ${!user.status})">${user.status ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
              <button class="action-btn btn-danger" onclick="deleteUser('${user.id}')">åˆ é™¤</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      // æ·»åŠ æ ·å¼
      addTableStyles();
    }
    
    // æ·»åŠ ç”¨æˆ·
    async function addUser() {
      try {
        const username = document.getElementById('username').value.trim();
        const name = document.getElementById('name').value.trim();
        const className = document.getElementById('class').value.trim();
        const password = document.getElementById('password').value.trim() || '123456';
        const role = document.getElementById('role').value;
        
        if (!username || !name || !className) {
          throw new Error('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        }
        
        if (!supabase) {
          throw new Error('æ•°æ®åº“è¿æ¥å¼‚å¸¸');
        }
        
        const { error } = await supabase
          .from('users')
          .insert([{
            username,
            name,
            class: className,
            password,
            role,
            status: true,
            created_at: new Date().toISOString()
          }]);
        
        if (error) throw error;
        
        showAlert('addAlert', 'ç”¨æˆ·æ·»åŠ æˆåŠŸï¼', 'success');
        clearAddForm();
        await loadUsers();
      } catch (error) {
        console.error('æ·»åŠ ç”¨æˆ·å¤±è´¥:', error);
        showAlert('addAlert', 'æ·»åŠ ç”¨æˆ·å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // æ‰¹é‡å¯¼å…¥
    async function batchImport() {
      const csvData = document.getElementById('batchData').value.trim();
      if (!csvData) {
        showAlert('addAlert', 'è¯·è¾“å…¥CSVæ•°æ®', 'error');
        return;
      }
      
      const lines = csvData.split('\n');
      const usersToAdd = [];
      let successCount = 0;
      
      for (const line of lines) {
        const [username, name, className, password] = line.split(',').map(item => item?.trim());
        if (username && name && className) {
          usersToAdd.push({
            username,
            name,
            class: className,
            password: password || '123456',
            role: username.toLowerCase().includes('teacher') ? 'teacher' : 'student',
            status: true,
            created_at: new Date().toISOString()
          });
        }
      }
      
      if (usersToAdd.length === 0) {
        showAlert('addAlert', 'æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆæ•°æ®', 'error');
        return;
      }
      
      try {
        for (const user of usersToAdd) {
          const { error } = await supabase
            .from('users')
            .insert([user]);
          
          if (!error) successCount++;
        }
        
        showAlert('addAlert', `æˆåŠŸå¯¼å…¥ ${successCount}/${usersToAdd.length} ä¸ªç”¨æˆ·`, 'success');
        document.getElementById('batchData').value = '';
        await loadUsers();
      } catch (error) {
        showAlert('addAlert', 'æ‰¹é‡å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // æœç´¢ç”¨æˆ·
    function searchUsers() {
      const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
      
      if (!keyword) {
        showAlert('tableAlert', 'è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error');
        return;
      }
      
      const filtered = usersCache.filter(user =>
        (user.username && user.username.toLowerCase().includes(keyword)) ||
        (user.name && user.name.toLowerCase().includes(keyword)) ||
        (user.class && user.class.toLowerCase().includes(keyword))
      );
      
      renderUserTable(filtered);
      showAlert('tableAlert', `æ‰¾åˆ° ${filtered.length} ä¸ªåŒ¹é…ç»“æœ`, 'success');
    }
    
    // ç¼–è¾‘ç”¨æˆ·
    async function editUser(id) {
      const user = usersCache.find(u => u.id === id);
      if (!user) return;
      
      const newName = prompt('è¯·è¾“å…¥æ–°å§“å:', user.name);
      if (newName === null) return;
      
      const newClass = prompt('è¯·è¾“å…¥æ–°ç­çº§:', user.class);
      if (newClass === null) return;
      
      try {
        const { error } = await supabase
          .from('users')
          .update({ name: newName, class: newClass })
          .eq('id', id);
        
        if (error) throw error;
        
        showAlert('tableAlert', 'ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°', 'success');
        await loadUsers();
      } catch (error) {
        showAlert('tableAlert', 'æ›´æ–°å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
    async function toggleUserStatus(id, newStatus) {
      try {
        const { error } = await supabase
          .from('users')
          .update({ status: newStatus })
          .eq('id', id);
        
        if (error) throw error;
        
        showAlert('tableAlert', `ç”¨æˆ·å·²${newStatus ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'success');
        await loadUsers();
      } catch (error) {
        showAlert('tableAlert', 'çŠ¶æ€æ›´æ–°å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // åˆ é™¤ç”¨æˆ·
    async function deleteUser(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
      
      try {
        const { error } = await supabase
          .from('users')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showAlert('tableAlert', 'ç”¨æˆ·å·²åˆ é™¤', 'success');
        await loadUsers();
      } catch (error) {
        showAlert('tableAlert', 'åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // å¯¼å‡ºCSV
    function exportUsers() {
      if (usersCache.length === 0) {
        showAlert('tableAlert', 'æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'error');
        return;
      }
      
      let csv = 'ç”¨æˆ·å,å§“å,ç­çº§,è§’è‰²,çŠ¶æ€\n';
      usersCache.forEach(user => {
        csv += `${user.username},${user.name},${user.class},${getRoleLabel(user.role)},${user.status ? 'æ´»è·ƒ' : 'ç¦ç”¨'}\n`;
      });
      
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `ç”¨æˆ·æ•°æ®_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }
    
    // ================== è¾…åŠ©å‡½æ•° ==================
    
    function setupEventListeners() {
      // å›è½¦é”®æœç´¢
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchUsers();
      });
    }
    
    function updateStats(users) {
      const total = users.length;
      const students = users.filter(u => u.role === 'student').length;
      const teachers = users.filter(u => u.role === 'teacher').length;
      const active = users.filter(u => u.status).length;
      
      document.getElementById('totalUsers').textContent = total;
      document.getElementById('studentUsers').textContent = students;
      document.getElementById('teacherUsers').textContent = teachers;
      document.getElementById('activeUsers').textContent = active;
    }
    
    function getRoleLabel(role) {
      const labels = { student: 'å­¦ç”Ÿ', teacher: 'æ•™å¸ˆ', admin: 'ç®¡ç†å‘˜' };
      return labels[role] || role;
    }
    
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN');
    }
    
    function showAlert(elementId, message, type = 'error') {
      const alert = document.getElementById(elementId);
      alert.textContent = message;
      alert.className = `alert alert-${type}`;
      alert.style.display = 'block';
      setTimeout(() => alert.style.display = 'none', 5000);
    }
    
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
    
    function clearAddForm() {
      document.getElementById('username').value = '';
      document.getElementById('name').value = '';
      document.getElementById('class').value = '';
      document.getElementById('password').value = '';
    }
    
    function resetSearch() {
      document.getElementById('searchInput').value = '';
      renderUserTable(usersCache);
    }
    
    function addTableStyles() {
      const style = document.createElement('style');
      style.textContent = `
        .role-badge { 
          background: #e9ecef; 
          padding: 2px 8px; 
          border-radius: 12px; 
          font-size: 12px; 
        }
        .status-badge { 
          padding: 2px 8px; 
          border-radius: 12px; 
          font-size: 12px; 
        }
        .status-badge.active { 
          background: #d4edda; 
          color: #155724; 
        }
        .status-badge.inactive { 
          background: #f8d7da; 
          color: #721c24; 
        }
        .action-btn { 
          padding: 4px 8px; 
          font-size: 12px; 
          border-radius: 3px; 
          cursor: pointer; 
        }
      `;
      document.head.appendChild(style);
    }
    
  </script>
</body>
</html>
