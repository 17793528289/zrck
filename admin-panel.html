<!DOCTYPE html>
<html>
<head>
  <title>用户管理系统</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; }
    .panel { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    input, button, select { padding: 10px; margin: 5px; }
    button { background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background-color: #f8f9fa; }
    .error { color: #dc3545; margin: 10px 0; padding: 10px; background: #f8d7da; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>用户管理系统</h1>
    
    <!-- 添加用户面板 -->
    <div class="panel">
      <h2>添加用户</h2>
      <div id="addError" class="error" style="display: none;"></div>
      <input id="username" placeholder="用户名" required>
      <input id="password" placeholder="密码" type="password" required>
      <input id="name" placeholder="姓名" required>
      <input id="class" placeholder="班级/部门" required>
      <select id="role">
        <option value="student">学生</option>
        <option value="teacher">教师</option>
        <option value="admin">管理员</option>
      </select>
      <button id="addUserBtn">添加用户</button>
    </div>
    
    <!-- 用户列表 -->
    <div class="panel">
      <h2>用户列表</h2>
      <div id="tableError" class="error" style="display: none;"></div>
      <table id="userTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>用户名</th>
            <th>姓名</th>
            <th>班级/部门</th>
            <th>角色</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // 修复关键：只声明一次 Supabase 客户端
    (function() {
      // 初始化 Supabase 客户端
      const supabaseUrl = 'https://wxbemuwgiiucdgmbhbvg.supabase.co';
      const supabaseKey = 'sb_publishable_KuzTRmYOZ9P6UmKgmb_VwA_6Qj_A6Nk';
      
      // 确保全局只声明一次
      if (!window.supabaseClient) {
        window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        console.log('Supabase 客户端已初始化');
      }
      
      // 全局引用
      const supabase = window.supabaseClient;
      
      // 页面加载完成后初始化
      document.addEventListener('DOMContentLoaded', function() {
        console.log('页面加载完成');
        
        // 绑定添加用户按钮事件
        document.getElementById('addUserBtn').addEventListener('click', addUser);
        
        // 加载用户数据
        loadUsers();
      });
      
      // 加载用户列表
      async function loadUsers() {
        try {
          console.log('正在加载用户数据...');
          
          if (!supabase || typeof supabase.from !== 'function') {
            throw new Error('Supabase 客户端未正确初始化');
          }
          
          const { data, error } = await supabase
            .from('users')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          
          console.log('成功加载用户数据:', data);
          renderUserTable(data);
        } catch (error) {
          console.error('加载用户失败:', error);
          showError('tableError', '加载用户失败: ' + error.message);
        }
      }
      
      // 渲染用户表格
      function renderUserTable(users) {
        const tbody = document.querySelector('#userTable tbody');
        tbody.innerHTML = '';
        
        if (!users || users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">没有用户数据</td></tr>';
          return;
        }
        
        users.forEach(user => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${user.id || '-'}</td>
            <td>${user.username || '-'}</td>
            <td>${user.name || '-'}</td>
            <td>${user.class || '-'}</td>
            <td>${getRoleName(user.role)}</td>
            <td>
              <button onclick="editUser('${user.id}')">编辑</button>
              <button onclick="deleteUser('${user.id}')">删除</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }
      
      // 添加用户函数
      async function addUser() {
        try {
          // 获取表单数据
          const username = document.getElementById('username').value.trim();
          const password = document.getElementById('password').value.trim() || '123456';
          const name = document.getElementById('name').value.trim();
          const className = document.getElementById('class').value.trim();
          const role = document.getElementById('role').value;
          
          // 验证输入
          if (!username) {
            throw new Error('用户名不能为空');
          }
          if (!name) {
            throw new Error('姓名不能为空');
          }
          
          console.log('正在添加用户:', { username, name, className, role });
          
          // 验证 Supabase 客户端
          if (!supabase || typeof supabase.from !== 'function') {
            throw new Error('数据库连接失败，请刷新页面重试');
          }
          
          // 插入数据
          const { error } = await supabase
            .from('users')
            .insert([{
              username,
              name,
              class: className,
              password,
              role,
              status: true,
              created_at: new Date().toISOString()
            }]);
          
          if (error) throw error;
          
          alert('用户添加成功！');
          
          // 清空表单
          document.getElementById('username').value = '';
          document.getElementById('password').value = '';
          document.getElementById('name').value = '';
          document.getElementById('class').value = '';
          
          // 重新加载用户列表
          loadUsers();
        } catch (error) {
          console.error('添加用户失败:', error);
          showError('addError', '添加用户失败: ' + error.message);
        }
      }
      
      // 编辑用户
      async function editUser(userId) {
        const newPassword = prompt('请输入新密码（留空则不修改）');
        if (newPassword === null) return;
        
        try {
          const updates = {};
          if (newPassword) updates.password = newPassword;
          
          if (Object.keys(updates).length === 0) return;
          
          const { error } = await supabase
            .from('users')
            .update(updates)
            .eq('id', userId);
          
          if (error) throw error;
          
          alert('密码已更新');
          loadUsers();
        } catch (error) {
          console.error('更新用户失败:', error);
          alert('更新用户失败: ' + error.message);
        }
      }
      
      // 删除用户
      async function deleteUser(userId) {
        if (!confirm('确定要删除这个用户吗？')) return;
        
        try {
          const { error } = await supabase
            .from('users')
            .delete()
            .eq('id', userId);
          
          if (error) throw error;
          
          alert('用户已删除');
          loadUsers();
        } catch (error) {
          console.error('删除用户失败:', error);
          alert('删除用户失败: ' + error.message);
        }
      }
      
      // 辅助函数
      function getRoleName(role) {
        const roles = {
          'student': '学生',
          'teacher': '教师',
          'admin': '管理员'
        };
        return roles[role] || role;
      }
      
      function showError(elementId, message) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = message;
          element.style.display = 'block';
        }
      }
      
      // 暴露函数到全局作用域
      window.addUser = addUser;
      window.editUser = editUser;
      window.deleteUser = deleteUser;
      window.loadUsers = loadUsers;
      
    })(); // 立即执行函数，避免变量污染
  </script>
</body>
</html>
