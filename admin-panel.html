<!DOCTYPE html>
<html>
<head>
  <title>用户管理系统</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    button { padding: 8px 12px; margin: 5px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    input { padding: 8px; margin: 5px; width: 200px; }
    .panel { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 5px; }
    .error { color: red; margin: 5px 0; }
  </style>
</head>
<body>
  <h1>用户管理系统</h1>
  
  <div class="panel">
    <h2>添加用户</h2>
    <input id="username" placeholder="用户名" required>
    <input id="password" placeholder="密码" type="password" required>
    <select id="role">
      <option value="student">学生</option>
      <option value="teacher">教师</option>
      <option value="admin">管理员</option>
    </select>
    <button onclick="addUser()">添加用户</button>
    <div id="addError" class="error"></div>
  </div>

  <div class="panel">
    <h2>搜索用户</h2>
    <input id="searchKeyword" placeholder="输入用户名或ID">
    <button onclick="searchUser()">搜索</button>
    <button onclick="loadUsers()">重置</button>
    <div id="searchError" class="error"></div>
  </div>

  <div class="panel">
    <h2>用户列表</h2>
    <table id="userTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>用户名</th>
          <th>角色</th>
          <th>状态</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="tableError" class="error"></div>
  </div>

  <script>
    // 初始化Supabase客户端
    const supabaseUrl = 'https://wxbemuwgiiucdgmbhbvg.supabase.co';
    const supabaseKey = 'sb_publishable_KuzTRmYOZ9P6UmKgmb_VwA_6Qj_A6Nk';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', () => {
      loadUsers();
    });

    // 加载用户列表
    async function loadUsers() {
      try {
        document.getElementById('tableError').textContent = '';
        const { data, error } = await supabase
          .from('users')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        renderUserTable(data);
      } catch (error) {
        console.error('加载用户失败:', error);
        document.getElementById('tableError').textContent = '加载用户失败: ' + error.message;
      }
    }

    // 渲染用户表格
    function renderUserTable(users) {
      const tbody = document.querySelector('#userTable tbody');
      tbody.innerHTML = '';
      
      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">没有找到用户</td></tr>';
        return;
      }
      
      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${user.id}</td>
          <td>${user.username}</td>
          <td>${user.role}</td>
          <td>${user.status ? '活跃' : '禁用'}</td>
          <td>
            <button onclick="editUser('${user.id}')">编辑</button>
            <button onclick="toggleStatus('${user.id}', ${!user.status})">
              ${user.status ? '禁用' : '启用'}
            </button>
            <button onclick="deleteUser('${user.id}')">删除</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 添加用户
    async function addUser() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const role = document.getElementById('role').value;
      
      if (!username || !password) {
        document.getElementById('addError').textContent = '用户名和密码不能为空';
        return;
      }
      
      try {
        document.getElementById('addError').textContent = '';
        const { error } = await supabase
          .from('users')
          .insert([{ 
            username, 
            password, 
            role,
            status: true,
            created_at: new Date().toISOString()
          }]);
        
        if (error) throw error;
        
        alert('用户添加成功');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        loadUsers();
      } catch (error) {
        console.error('添加用户失败:', error);
        document.getElementById('addError').textContent = '添加用户失败: ' + error.message;
      }
    }

    // 搜索用户
    async function searchUser() {
      const keyword = document.getElementById('searchKeyword').value.trim();
      
      try {
        document.getElementById('searchError').textContent = '';
        if (!keyword) {
          loadUsers();
          return;
        }
        
        const { data, error } = await supabase
          .from('users')
          .select('*')
          .or(`username.ilike.%${keyword}%,id.eq.${keyword}`)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        renderUserTable(data);
      } catch (error) {
        console.error('搜索用户失败:', error);
        document.getElementById('searchError').textContent = '搜索用户失败: ' + error.message;
      }
    }

    // 编辑用户
    async function editUser(id) {
      const newPassword = prompt('输入新密码（留空则不修改）');
      if (newPassword === null) return;
      
      try {
        const updates = {};
        if (newPassword) updates.password = newPassword;
        
        if (Object.keys(updates).length === 0) return;
        
        const { error } = await supabase
          .from('users')
          .update(updates)
          .eq('id', id);
        
        if (error) throw error;
        
        alert('用户信息已更新');
        loadUsers();
      } catch (error) {
        console.error('更新用户失败:', error);
        alert('更新用户失败: ' + error.message);
      }
    }

    // 切换用户状态
    async function toggleStatus(id, newStatus) {
      try {
        const { error } = await supabase
          .from('users')
          .update({ status: newStatus })
          .eq('id', id);
        
        if (error) throw error;
        
        alert(`用户已${newStatus ? '启用' : '禁用'}`);
        loadUsers();
      } catch (error) {
        console.error('状态更新失败:', error);
        alert('状态更新失败: ' + error.message);
      }
    }

    // 删除用户
    async function deleteUser(id) {
      if (!confirm('确定删除这个用户吗？')) return;
      
      try {
        const { error } = await supabase
          .from('users')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        alert('用户已删除');
        loadUsers();
      } catch (error) {
        console.error('删除用户失败:', error);
        alert('删除用户失败: ' + error.message);
      }
    }
  </script>
</body>
</html>
